@model IEnumerable<WebApplicationAchats.Models.Produit>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

@if (User.IsInRole("Admin"))
{
    <p>
        <a asp-action="Create" class="btn btn-success">Create New</a>
    </p>
}

@* Barre de recherche *@
<form asp-action="Index" method="get" class="form-inline mb-3">
    <div class="form-group">
        <input type="text" name="searchString" value="@ViewData["CurrentFilter"]"
               class="form-control" placeholder="Rechercher un produit" />
        <button type="submit" class="btn btn-primary ml-2">Rechercher</button>
    </div>
</form>

@* Boutons de filtrage par disponibilité *@
<div class="btn-group mb-3">
    <a asp-action="Index" class="btn btn-outline-secondary">Tous</a>
    <a asp-action="Index" asp-route-filter="disponible" class="btn btn-outline-success">
        Disponibles
    </a>
    <a asp-action="Index" asp-route-filter="indisponible" class="btn btn-outline-danger">
        Indisponibles
    </a>
</div>

@* Boutons de tri par prix *@
<div class="btn-group mb-3 ms-2">
    <a asp-action="Index" asp-route-sortOrder="prix_asc" class="btn btn-outline-primary">
        Prix ↑
    </a>
    <a asp-action="Index" asp-route-sortOrder="prix_desc" class="btn btn-outline-primary">
        Prix ↓
    </a>
</div>

@* Compteur de produits disponibles *@
<div class="alert alert-info mb-3">
    <strong>📊 Produits disponibles :</strong>
    <span class="badge bg-success">@ViewBag.NombreDisponibles</span>
</div>

@* Statistiques par catégorie *@
<div class="card mb-3">
    <div class="card-header">
        <strong>📊 Nombre de produits par catégorie</strong>
    </div>
    <div class="card-body">
        @if (ViewBag.StatsParCategorie != null)
        {
            <div class="row">
                @foreach (var item in ViewBag.StatsParCategorie)
                {
                    <div class="col-md-4 mb-2">
                        <div class="alert alert-secondary mb-0">
                            <strong>@item.Categorie</strong> :
                            <span class="badge bg-primary">@item.Total produit(s)</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted">Aucune statistique disponible</p>
        }
    </div>
</div>

@* Tableau principal des produits *@
<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>@Html.DisplayNameFor(model => model.Nom)</th>
            <th>@Html.DisplayNameFor(model => model.Description)</th>
            <th>@Html.DisplayNameFor(model => model.Prix)</th>
            <th>@Html.DisplayNameFor(model => model.Quantite)</th>
            <th>@Html.DisplayNameFor(model => model.DateAjout)</th>
            <th>Disponible</th>
            <th>@Html.DisplayNameFor(model => model.Categorie)</th>
            <th>@Html.DisplayNameFor(model => model.Marque)</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@Html.DisplayFor(modelItem => item.Nom)</td>
                <td>@Html.DisplayFor(modelItem => item.Description)</td>
                <td>@Html.DisplayFor(modelItem => item.Prix)</td>
                <td>@Html.DisplayFor(modelItem => item.Quantite)</td>
                <td>@Html.DisplayFor(modelItem => item.DateAjout)</td>
                <td>
                    @if (item.Disponible)
                    {
                        <span class="badge bg-success">Disponible</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">Indisponible</span>
                    }
                </td>
                <td>@Html.DisplayFor(modelItem => item.Categorie.Nom)</td>
                <td>@Html.DisplayFor(modelItem => item.Marque.Nom)</td>
                <td>
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                    {
                        <a asp-action="Edit" asp-route-id="@item.Id">Edit</a>
                        <text> | </text>
                    }
                    <a asp-action="Details" asp-route-id="@item.Id">Details</a>
                    @if (User.IsInRole("Admin"))
                    {
                        <text> | </text>
                        <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@* Tableau de jointure LINQ *@
<div class="card mt-4">
    <div class="card-header">
        <h4>🔗 Résultats LINQ JOIN catégories</h4>
    </div>
    <div class="card-body">
        @if (ViewBag.JoinProduitsCategories != null)
        {
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Produit</th>
                        <th>Prix</th>
                        <th>Catégorie</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ViewBag.JoinProduitsCategories)
                    {
                        <tr>
                            <td>@item.Produit</td>
                            <td>@item.Prix.ToString("N2") DH</td>
                            <td><span class="badge bg-info">@item.Categorie</span></td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-muted">Aucune donnée disponible</p>
        }
    </div>
</div>